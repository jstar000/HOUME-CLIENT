name: 'Chromatic'

on:
  push:
    branches: [develop, main]
  pull_request:
    types: [opened, synchronize, reopened]

permissions: write-all

jobs:
  chromatic:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. PNPM ì„¤ì •
      - uses: pnpm/action-setup@v4

      # 3. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'pnpm'

      # 4. ì˜ì¡´ì„± ìºì‹±
      - name: Cache node modules
        id: cache-node
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 5. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        if: steps.cache-node.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

      # 6. ìŠ¤í† ë¦¬ë¶ ë¹Œë“œ
      - name: Build Storybook
        run: pnpm build-storybook

      # 7. Chromatic ë°°í¬ (ì¬ì‹œë„ í¬í•¨)
      - name: Publish to Chromatic
        id: chromatic
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            npx chromatic \
              --project-token=${{ secrets.CHROMATIC_PROJECT_TOKEN }} \
              --storybook-build-dir=storybook-static \
              --only-changed=${{ github.event_name == 'pull_request' && 'true' || 'false' }} \
              --auto-accept-changes=${{ github.ref == 'refs/heads/develop' && 'true' || 'false' }} \
              --exit-zero-on-changes

      # 8. ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
      - name: Create Coverage Report
        id: coverage
        if: always()
        run: |
          echo "## ğŸ“Š Storybook Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Components**: $(find src -name "*.stories.tsx" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ${{ steps.chromatic.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Storybook URL**: ${{ steps.chromatic.outputs.storybookUrl || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY

      # 9. PR ì½”ë©˜íŠ¸
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: chromatic-build
          message: |
            ## ğŸ¨ Storybook ë¹Œë“œ ì™„ë£Œ!

            ğŸ“š **Storybook**: ${{ steps.chromatic.outputs.storybookUrl }}
            ğŸ” **Chromatic**: ${{ steps.chromatic.outputs.buildUrl }}

            ### ğŸ“Š ë¹Œë“œ ì •ë³´
            - **ì»´í¬ë„ŒíŠ¸ ìˆ˜**: $(find src -name "*.stories.tsx" | wc -l)ê°œ
            - **ë¹Œë“œ ì‹œê°„**: ${{ steps.chromatic.outputs.buildTime }}ms
            - **ë³€ê²½ì‚¬í•­**: ${{ steps.chromatic.outputs.changeCount }}ê°œ

            <details>
            <summary>ìƒì„¸ ì •ë³´</summary>

            - Component Count: ${{ steps.chromatic.outputs.componentCount }}
            - Story Count: ${{ steps.chromatic.outputs.storyCount }}
            - Spec Count: ${{ steps.chromatic.outputs.specCount }}
            </details>

      # 10. Discord ì•Œë¦¼
      - name: Discord Notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "Chromatic ë¹Œë“œ ${{ job.status == 'success' && 'ì„±ê³µ âœ…' || 'ì‹¤íŒ¨ âŒ' }}"
          description: |
            **í”„ë¡œì íŠ¸**: ${{ github.repository }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ì‹¤í–‰ì**: ${{ github.actor }}
          color: ${{ job.status == 'success' && 0x00ff00 || 0xff0000 }}
          url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          username: HOUME Bot
          avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
