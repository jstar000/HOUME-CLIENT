# Chromatic ìŠ¤í† ë¦¬ë¶ ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìŠ¤í† ë¦¬ë¶ì„ ë¹Œë“œí•˜ê³  Chromaticì— ë°°í¬í•˜ì—¬ ì‹œê°ì  íšŒê·€ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# Chromaticì€ ìŠ¤í† ë¦¬ë¶ì˜ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ë¥¼ ìŠ¤í¬ë¦°ìƒ·ìœ¼ë¡œ ìº¡ì²˜í•˜ê³  ë³€ê²½ì‚¬í•­ì„ ì¶”ì í•©ë‹ˆë‹¤.

name: 'Chromatic'

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # develop, main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
  # - develop: ê°œë°œ í™˜ê²½ì˜ ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸
  # - main: í”„ë¡œë•ì…˜ í™˜ê²½ì˜ ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸
  push:
    branches: [develop, main]

  # PRì´ ìƒì„±, ì—…ë°ì´íŠ¸, ì¬ì˜¤í”ˆë  ë•Œ ì‹¤í–‰
  # - opened: ìƒˆë¡œìš´ PR ìƒì„± ì‹œ
  # - synchronize: PRì— ìƒˆë¡œìš´ ì»¤ë°‹ ì¶”ê°€ ì‹œ
  # - reopened: ë‹«í˜”ë˜ PRì„ ë‹¤ì‹œ ì—´ ë•Œ
  pull_request:
    types: [opened, synchronize, reopened]

# GitHub í† í° ê¶Œí•œ ì„¤ì •
# write-all: PR ì½”ë©˜íŠ¸ ì‘ì„± ë° ì›Œí¬í”Œë¡œìš° ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í•„ìš”
permissions: write-all

jobs:
  chromatic:
    # Ubuntu ìµœì‹  ë²„ì „ í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest

    # ì¡°ê±´ë¶€ ì‹¤í–‰: Draft PRì¸ ê²½ìš° ì›Œí¬í”Œë¡œìš° ìŠ¤í‚µ
    # Draft PRì€ ì•„ì§ ë¦¬ë·° ì¤€ë¹„ê°€ ì•ˆ ëœ ìƒíƒœì´ë¯€ë¡œ ë¦¬ì†ŒìŠ¤ ì ˆì•½
    if: github.event.pull_request.draft == false

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      # ì½”ë“œë¥¼ GitHub Actions ëŸ¬ë„ˆì— ë³µì‚¬í•©ë‹ˆë‹¤.
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 - ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜´
          # Chromaticì´ ë³€ê²½ì‚¬í•­ì„ ì •í™•íˆ ì¶”ì í•˜ê¸° ìœ„í•´ í•„ìš”
          fetch-depth: 0

      # 2. PNPM íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
      # package.jsonì˜ packageManager í•„ë“œë¥¼ ì½ì–´ ì˜¬ë°”ë¥¸ ë²„ì „ ìë™ ì„¤ì¹˜
      - uses: pnpm/action-setup@v4

      # 3. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 22.x ë²„ì „ ì‚¬ìš© (í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­ê³¼ ì¼ì¹˜)
          node-version: '22.x'
          # pnpm ìºì‹œ í™œì„±í™”ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ ì†ë„ í–¥ìƒ
          cache: 'pnpm'

      # 4. ì˜ì¡´ì„± ìºì‹±
      # node_modulesë¥¼ ìºì‹œí•˜ì—¬ ë°˜ë³µì ì¸ ì„¤ì¹˜ ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.
      - name: Cache node modules
        id: cache-node
        uses: actions/cache@v3
        with:
          # ìºì‹œí•  ê²½ë¡œë“¤
          path: |
            **/node_modules        # ëª¨ë“  node_modules ë””ë ‰í† ë¦¬
            ~/.cache/Cypress       # Cypress ë°”ì´ë„ˆë¦¬ ìºì‹œ (ìˆì„ ê²½ìš°)
          # ìºì‹œ í‚¤: OS + pnpm-lock.yaml í•´ì‹œê°’
          # pnpm-lock.yamlì´ ë³€ê²½ë˜ë©´ ìƒˆë¡œìš´ ìºì‹œ ìƒì„±
          key: ${{ runner.os }}-node-${{ hashFiles('**/pnpm-lock.yaml') }}
          # ì •í™•í•œ í‚¤ê°€ ì—†ì„ ë•Œ ì‚¬ìš©í•  ëŒ€ì²´ í‚¤ (ë¶€ë¶„ ë§¤ì¹­)
          restore-keys: |
            ${{ runner.os }}-node-

      # 5. ì˜ì¡´ì„± ì„¤ì¹˜
      # ìºì‹œê°€ ì—†ê±°ë‚˜ ì˜¤ë˜ëœ ê²½ìš°ì—ë§Œ ì„¤ì¹˜ ì‹¤í–‰
      - name: Install Dependencies
        # ìºì‹œ íˆíŠ¸ê°€ ì—†ì„ ë•Œë§Œ ì‹¤í–‰ (cache-hit != 'true')
        if: steps.cache-node.outputs.cache-hit != 'true'
        # --frozen-lockfile: lock íŒŒì¼ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë²„ì „ë§Œ ì„¤ì¹˜
        # CI í™˜ê²½ì—ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ì—…ë°ì´íŠ¸ ë°©ì§€
        run: pnpm install --frozen-lockfile

      # 6. ìŠ¤í† ë¦¬ë¶ ë¹Œë“œ
      # ëª¨ë“  ìŠ¤í† ë¦¬ë¥¼ ì •ì  íŒŒì¼ë¡œ ë¹Œë“œí•˜ì—¬ storybook-static í´ë”ì— ì €ì¥
      - name: Build Storybook
        run: pnpm build-storybook

      # 7. Chromatic ë°°í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
      # ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë‚˜ ì¼ì‹œì  ì˜¤ë¥˜ì— ëŒ€ì‘í•˜ê¸° ìœ„í•œ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜
      - name: Publish to Chromatic
        id: chromatic
        uses: nick-fields/retry@v2
        with:
          # ìµœëŒ€ 10ë¶„ ë™ì•ˆ ì‹œë„
          timeout_minutes: 10
          # ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
          max_attempts: 3
          # ì‹¤í–‰í•  ëª…ë ¹ì–´
          command: |
            npx chromatic \
              --project-token=${{ secrets.CHROMATIC_PROJECT_TOKEN }} \
              --storybook-build-dir=storybook-static \
              --only-changed=${{ github.event_name == 'pull_request' && 'true' || 'false' }} \
              --auto-accept-changes=${{ github.ref == 'refs/heads/develop' && 'true' || 'false' }} \
              --exit-zero-on-changes

      # Chromatic CLI ì˜µì…˜ ì„¤ëª…:
      # --project-token: Chromatic í”„ë¡œì íŠ¸ ì¸ì¦ í† í° (í•„ìˆ˜)
      # --storybook-build-dir: ì´ë¯¸ ë¹Œë“œëœ ìŠ¤í† ë¦¬ë¶ ë””ë ‰í† ë¦¬ ì§€ì • (ë¹Œë“œ ì‹œê°„ ì ˆì•½)
      # --only-changed: PRì—ì„œë§Œ true - ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ í…ŒìŠ¤íŠ¸í•˜ì—¬ ì†ë„ í–¥ìƒ
      # --auto-accept-changes: develop ë¸Œëœì¹˜ì—ì„œë§Œ true - ìë™ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ ìŠ¹ì¸
      # --exit-zero-on-changes: ì‹œê°ì  ë³€ê²½ì´ ìˆì–´ë„ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (CI ì‹¤íŒ¨ ë°©ì§€)

      # 8. ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
      # GitHub Actions ìš”ì•½ í˜ì´ì§€ì— ìŠ¤í† ë¦¬ë¶ ìƒíƒœ ì •ë³´ ì¶œë ¥
      - name: Create Coverage Report
        id: coverage
        # always(): ì´ì „ ë‹¨ê³„ ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        if: always()
        run: |
          # GITHUB_STEP_SUMMARY: GitHub Actions ìš”ì•½ í˜ì´ì§€ì— í‘œì‹œë  ë‚´ìš©
          echo "## ğŸ“Š Storybook Coverage Report" >> $GITHUB_STEP_SUMMARY
          # ìŠ¤í† ë¦¬ íŒŒì¼ ê°œìˆ˜ ê³„ì‚°
          echo "- **Total Components**: $(find src -name "*.stories.tsx" | wc -l)" >> $GITHUB_STEP_SUMMARY
          # Chromatic ë‹¨ê³„ì˜ ì‹¤í–‰ ê²°ê³¼ (success/failure)
          echo "- **Build Status**: ${{ steps.chromatic.outcome }}" >> $GITHUB_STEP_SUMMARY
          # ë°°í¬ëœ ìŠ¤í† ë¦¬ë¶ URL (ì—†ìœ¼ë©´ N/A í‘œì‹œ)
          echo "- **Storybook URL**: ${{ steps.chromatic.outputs.storybookUrl || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          # ë¹Œë“œ ì‹œê°„ ê¸°ë¡
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY

      # 9. PR ì½”ë©˜íŠ¸
      # PRì— ìŠ¤í† ë¦¬ë¶ ë§í¬ì™€ ë¹Œë“œ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ëŒ“ê¸€ë¡œ ì¶”ê°€
      - name: Comment PR
        # PR ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          # comment_tag: ë™ì¼í•œ íƒœê·¸ì˜ ê¸°ì¡´ ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ë°©ì§€)
          comment_tag: chromatic-build
          # ì½”ë©˜íŠ¸ ë‚´ìš©
          message: |
            ## ğŸ¨ Storybook ë¹Œë“œ ì™„ë£Œ!

            ğŸ“š **Storybook**: ${{ steps.chromatic.outputs.storybookUrl }}
            ğŸ” **Chromatic**: ${{ steps.chromatic.outputs.buildUrl }}

            ### ğŸ“Š ë¹Œë“œ ì •ë³´
            - **ì»´í¬ë„ŒíŠ¸ ìˆ˜**: $(find src -name "*.stories.tsx" | wc -l)ê°œ
            - **ë¹Œë“œ ì‹œê°„**: ${{ steps.chromatic.outputs.buildTime }}ms
            - **ë³€ê²½ì‚¬í•­**: ${{ steps.chromatic.outputs.changeCount }}ê°œ

            <details>
            <summary>ìƒì„¸ ì •ë³´</summary>

            - Component Count: ${{ steps.chromatic.outputs.componentCount }}
            - Story Count: ${{ steps.chromatic.outputs.storyCount }}
            - Spec Count: ${{ steps.chromatic.outputs.specCount }}
            </details>

      # 10. Discord ì•Œë¦¼
      # íŒ€ Discord ì±„ë„ì— ë¹Œë“œ ê²°ê³¼ ì•Œë¦¼ ì „ì†¡
      - name: Discord Notification
        # always(): ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì•Œë¦¼
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          # Discord ì›¹í›… URL (GitHub Secretsì— ì €ì¥)
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          # ì•Œë¦¼ ì œëª©: ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼ ë‹¤ë¥¸ ì´ëª¨ì§€ í‘œì‹œ
          title: "Chromatic ë¹Œë“œ ${{ job.status == 'success' && 'ì„±ê³µ âœ…' || 'ì‹¤íŒ¨ âŒ' }}"
          # ì•Œë¦¼ ë³¸ë¬¸: í”„ë¡œì íŠ¸ ì •ë³´
          description: |
            **í”„ë¡œì íŠ¸**: ${{ github.repository }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ì‹¤í–‰ì**: ${{ github.actor }}
          # ì„ë² ë“œ ìƒ‰ìƒ: ì„±ê³µ=ì´ˆë¡ìƒ‰(0x00ff00), ì‹¤íŒ¨=ë¹¨ê°„ìƒ‰(0xff0000)
          color: ${{ job.status == 'success' && 0x00ff00 || 0xff0000 }}
          # GitHub Actions ì‹¤í–‰ í˜ì´ì§€ ë§í¬
          url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          # Discordì— í‘œì‹œë  ë´‡ ì´ë¦„
          username: HOUME Bot
          # Discordì— í‘œì‹œë  ë´‡ ì•„ë°”íƒ€
          avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
